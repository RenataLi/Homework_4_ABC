     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fprintf
     4                                  
     5                                  extern Distance
     6                                  
     7                                  extern AUTOMOBILE
     8                                  extern BUS
     9                                  extern TRUCK
    10                                  
    11                                  ;----------------------------------------------
    12                                  ;void Out(train &t, ofstream &ofst) {
    13                                  ;    ofst << "It is a train: number of railway carriage = "
    14                                  ;         << t.numberOfRailwayCarriage << ", speed = " << t.speed
    15                                  ;         << ", distance = " << t.distance
    16                                  ;         << ". Ideal time = " << IdealTime(t) << "\n";
    17                                  ;}
    18                                  global OutAutomobile
    19                                  OutAutomobile:
    20                                  section .data
    21 00000000 497420697320612061-         .outfmt db "It is a automobile: fuel_consumption = %d, fuel_capacity = %d, max_speed = %d. Distanse = %lg",10,0
    21 00000009 75746F6D6F62696C65-
    21 00000012 3A206675656C5F636F-
    21 0000001B 6E73756D7074696F6E-
    21 00000024 203D2025642C206675-
    21 0000002D 656C5F636170616369-
    21 00000036 7479203D2025642C20-
    21 0000003F 6D61785F7370656564-
    21 00000048 203D2025642E204469-
    21 00000051 7374616E7365203D20-
    21 0000005A 256C670A00         
    22                                  section .bss
    23 00000000 <res 00000008>              .prect  resq  1
    24 00000008 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    25 00000010 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
    26                                  section .text
    27 00000000 55                      push rbp
    28 00000001 4889E5                  mov rbp, rsp
    29                                  
    30                                      ; Сохранени принятых аргументов
    31 00000004 48893C25[00000000]          mov     [.prect], rdi          ; сохраняется адрес поезда
    32 0000000C 48893425[08000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    33                                  
    34                                      ; Вычисление идеального времени|расстояния поезда/автомобиля (адрес уже в rdi)
    35 00000014 488B3C25[00000000]          mov     rdi, [.prect]
    36 0000001C E8(00000000)                call    Distance
    37 00000021 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) идельного времени
    37 00000026 [10000000]         
    38                                  
    39 0000002A 488B3C25[08000000]         mov     rdi, [.FILE]
    40 00000032 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    40 00000034 [0000000000000000] 
    41 0000003C 488B0425[00000000]          mov     rax, [.prect]      ; адрес треугольника
    42 00000044 488B08                      mov     rcx,[rax]          ; 0 int displacement
    43 00000047 488B5004                    mov     rdx, [rax+4]        ; +4 int type
    44 0000004B 4C8B4008                    mov     r8, [rax+8]       ; +4+4 int speed
    45                                     ; movsd   xmm0, [rax+12]    ; +4+4+4 double distance
    46 0000004F F20F100425-                 movsd   xmm0, [.p]
    46 00000054 [10000000]         
    47 00000058 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
    48 0000005D E8(00000000)                call    fprintf
    49                                      ; Вывод информации о поезде в файл
    50                                     ; mov     rdi, [.FILE]
    51                                  ;    mov     rsi, .outfmt        ; Формат - 2-й аргумент
    52                                  ;    mov     rax, [.prect]        ; адрес поезда
    53                                  ;    mov     esi, [rax]          ; x
    54                                  ;    mov     edx, [rax+4]        ; y
    55                                  ;    mov   ecx, [rax+8]
    56                                  ;    movsd   xmm0, [.p]
    57                                  ;    mov     rax, 1              ; есть числа с плавающей точкой
    58                                  ;    call    fprintf
    59                                  
    60 00000062 C9                      leave
    61 00000063 C3                      ret
    62                                  
    63                                  global OutBus
    64                                  OutBus:
    65                                  section .data
    66 0000005F 497420697320612062-         .outfmt db "It is a bus:  fuel_consumption =  %d, fuel_capacity = %d, passenger_capacity  =  %d. Distance = %lg",10,0
    66 00000068 75733A20206675656C-
    66 00000071 5F636F6E73756D7074-
    66 0000007A 696F6E203D20202564-
    66 00000083 2C206675656C5F6361-
    66 0000008C 706163697479203D20-
    66 00000095 25642C207061737365-
    66 0000009E 6E6765725F63617061-
    66 000000A7 6369747920203D2020-
    66 000000B0 25642E204469737461-
    66 000000B9 6E6365203D20256C67-
    66 000000C2 0A00               
    67                                  section .bss
    68 00000018 <res 00000008>              .ptrian  resq  1
    69 00000020 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    70 00000028 <res 00000008>              .p      resq  1       ; вычисленный периметр треугольника
    71                                  section .text
    72 00000064 55                      push rbp
    73 00000065 4889E5                  mov rbp, rsp
    74                                  
    75                                      ; Сохранени принятых аргументов
    76 00000068 48893C25[18000000]          mov     [.ptrian], rdi        ; сохраняется адрес ship
    77 00000070 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    78                                  
    79                                      ; Вычисление периметра треугольника (адрес уже в rdi)
    80 00000078 E8(00000000)                call    Distance
    81 0000007D F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    81 00000082 [28000000]         
    82                                  
    83                                      ; Вывод информации о треугольнике в консоль
    84                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    85                                  ;     mov     rax, [.ptrian]       ; адрес треугольника
    86                                  ;     mov     esi, [rax]          ; a
    87                                  ;     mov     edx, [rax+4]        ; b
    88                                  ;     mov     ecx, [rax+8]        ; c
    89                                  ;     movsd   xmm0, [.p]
    90                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
    91                                  ;     call    printf
    92                                  
    93                                      ; Вывод информации о bus в файл
    94 00000086 488B3C25[20000000]          mov     rdi, [.FILE]
    95 0000008E 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    95 00000090 [5F00000000000000] 
    96 00000098 488B0425[18000000]          mov     rax, [.ptrian]      ; адрес треугольника
    97 000000A0 488B08                      mov     rcx,[rax]          ; 0 int displacement
    98 000000A3 488B5004                    mov     rdx, [rax+4]        ; +4 int type
    99 000000A7 4C8B4008                    mov     r8, [rax+8]       ; +4+4 int speed
   100                                     ; movsd   xmm0, [rax+12]    ; +4+4+4 double distance
   101 000000AB F20F100425-                 movsd   xmm0, [.p]
   101 000000B0 [28000000]         
   102 000000B4 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   103 000000B9 E8(00000000)                call    fprintf
   104                                  
   105 000000BE C9                      leave
   106 000000BF C3                      ret
   107                                  
   108                                  
   109                                  global OutTruck
   110                                  OutTruck:
   111                                  section .data
   112 000000C4 497420697320612074-         .outfmt db "It is a truck:  fuel_consumption = %d, fuel_capacity = %d, lifting_capacity = %d. Distance = %lg",10,0
   112 000000CD 7275636B3A20206675-
   112 000000D6 656C5F636F6E73756D-
   112 000000DF 7074696F6E203D2025-
   112 000000E8 642C206675656C5F63-
   112 000000F1 61706163697479203D-
   112 000000FA 2025642C206C696674-
   112 00000103 696E675F6361706163-
   112 0000010C 697479203D2025642E-
   112 00000115 2044697374616E6365-
   112 0000011E 203D20256C670A00   
   113                                  section .bss
   114 00000030 <res 00000008>              .prect  resq  1
   115 00000038 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
   116 00000040 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
   117                                  section .text
   118 000000C0 55                      push rbp
   119 000000C1 4889E5                  mov rbp, rsp
   120                                  
   121                                      ; Сохранени принятых аргументов
   122 000000C4 48893C25[30000000]          mov     [.prect], rdi          ; сохраняется адрес поезда
   123 000000CC 48893425[38000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
   124                                  
   125                                      ; Вычисление идеального времени поезда (адрес уже в rdi)
   126 000000D4 488B3C25[30000000]          mov     rdi, [.prect]
   127 000000DC E8(00000000)                call    Distance
   128 000000E1 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) идельного времени
   128 000000E6 [40000000]         
   129                                      ; Вывод информации о поезде в файл
   130 000000EA 488B3C25[38000000]         mov     rdi, [.FILE]
   131 000000F2 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
   131 000000F4 [C400000000000000] 
   132 000000FC 488B0425[30000000]          mov     rax, [.prect]      ; адрес треугольника
   133 00000104 488B08                      mov     rcx,[rax]          ; 0 int displacement
   134 00000107 488B5004                    mov     rdx, [rax+4]        ; +4 int type
   135 0000010B 4C8B4008                    mov     r8, [rax+8]       ; +4+4 int speed
   136                                     ; movsd   xmm0, [rax+12]    ; +4+4+4 double distance
   137 0000010F F20F100425-                 movsd   xmm0, [.p]
   137 00000114 [40000000]         
   138 00000118 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   139 0000011D E8(00000000)                call    fprintf
   140                                  
   141 00000122 C9                      leave
   142 00000123 C3                      ret
   143                                  ;----------------------------------------------
   144                                  ; // Вывод параметров текущей фигуры в файл
   145                                  ; void OutC(void *s, FILE *ofst) {
   146                                  ;     int k = *((int*)s);
   147                                  ;     if(k == RECTANGLE) {
   148                                  ;         OutRectangle(s+intSize, ofst);
   149                                  ;     }
   150                                  ;     else if(k == TRIANGLE) {
   151                                  ;         OutShip(s+intSize, ofst);
   152                                  ;     }
   153                                  ;     else {
   154                                  ;         fprintf(ofst, "Incorrect figure!\n");
   155                                  ;     }
   156                                  ; }
   157                                  global OutCar
   158                                  OutCar:
   159                                  section .data
   160 00000126 496E636F7272656374-         .erShape db "Incorrect figure!",10,0
   160 0000012F 20666967757265210A-
   160 00000138 00                 
   161 00000139 74797065207472616E-         .outf db "type transoirt  = %d",10,0
   161 00000142 736F69727420203D20-
   161 0000014B 25640A00           
   162                                  section .text
   163 00000124 55                      push rbp
   164 00000125 4889E5                  mov rbp, rsp
   165                                  
   166                                      ; В rdi адрес фигуры
   167 00000128 8B07                        mov eax, [rdi]
   168                                      
   169                                  ;    mov rsi, [rdi]
   170                                  ;    mov rdi, .outf
   171                                  ;    mov rax , 0
   172                                  ;    call printf
   173                                  ;    mov [rdi], rsi
   174                                  ;    
   175                                      
   176 0000012A 3B0425[00000000]            cmp eax, [AUTOMOBILE] 
   177 00000131 7428                        je automobileOut
   178 00000133 3B0425[00000000]            cmp eax, [BUS] ; 
   179 0000013A 742A                        je busOut
   180 0000013C 3B0425[00000000]            cmp eax, [TRUCK]
   181 00000143 742C                        je truckOut
   182 00000145 48BF-                       mov rdi, .erShape
   182 00000147 [2601000000000000] 
   183 0000014F B800000000                  mov rax, 0
   184 00000154 E8(00000000)                call fprintf
   185 00000159 EB21                        jmp     return
   186                                  automobileOut:
   187                                      ; Вывод train
   188 0000015B 4883C704                    add     rdi, 4
   189 0000015F E89CFEFFFF                  call    OutAutomobile
   190 00000164 EB16                        jmp     return
   191                                  busOut:
   192                                      ; Вывод ship
   193 00000166 4883C704                    add     rdi, 4
   194 0000016A E8F5FEFFFF                  call    OutBus
   195 0000016F EB0B                        jmp     return
   196                                  truckOut:
   197 00000171 4883C704                    add     rdi, 4
   198 00000175 E846FFFFFF                  call    OutTruck
   199 0000017A EB00                        jmp     return
   200                                  return:
   201 0000017C C9                      leave
   202 0000017D C3                      ret
   203                                  
   204                                  ;----------------------------------------------
   205                                  ; // Вывод содержимого контейнера в файл
   206                                  ; void OutContainer(void *c, int len, FILE *ofst) {
   207                                  ;     void *tmp = c;
   208                                  ;     fprintf(ofst, "Container contains %d elements.\n", len);
   209                                  ;     for(int i = 0; i < len; i++) {
   210                                  ;         fprintf(ofst, "%d: ", i);
   211                                  ;         OutTransport(tmp, ofst);
   212                                  ;         tmp = tmp + shapeSize;
   213                                  ;     }
   214                                  ; }
   215                                  global OutContainer
   216                                  OutContainer:
   217                                  section .data
   218 0000014F 25643A2000                  numFmt  db  "%d: ",0
   219                                  section .bss
   220 00000048 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   221 00000050 <res 00000004>              .len    resd    1   ; адрес для сохранения числа введенных элементов
   222 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   223                                  section .text
   224 0000017E 55                      push rbp
   225 0000017F 4889E5                  mov rbp, rsp
   226                                  
   227 00000182 48893C25[48000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   228 0000018A 893425[50000000]            mov [.len],   esi     ; сохраняется число элементов
   229 00000191 48891425[54000000]          mov [.FILE],  rdx    ; сохраняется указатель на файл
   230                                  
   231                                      ; В rdi адрес начала контейнера
   232 00000199 4889F3                      mov rbx, rsi            ; число фигур
   233 0000019C 31C9                        xor ecx, ecx            ; счетчик фигур = 0
   234 0000019E 4889D6                      mov rsi, rdx            ; перенос указателя на файл
   235                                  .loop:
   236 000001A1 39D9                        cmp ecx, ebx            ; проверка на окончание цикла
   237 000001A3 7D4D                        jge .return             ; Перебрали все фигуры
   238                                  
   239 000001A5 53                          push rbx
   240 000001A6 51                          push rcx
   241                                  
   242                                      ; Вывод номера фигуры
   243 000001A7 488B3C25[54000000]          mov     rdi, [.FILE]    ; текущий указатель на файл
   244 000001AF 48BE-                       mov     rsi, numFmt     ; формат для вывода фигуры
   244 000001B1 [4F01000000000000] 
   245 000001B9 89CA                        mov     edx, ecx        ; индекс текущей фигуры
   246 000001BB 4831C0                      xor     rax, rax,       ; только целочисленные регистры
   247 000001BE E8(00000000)                call fprintf
   248                                  
   249                                      ; Вывод текущей фигуры
   250 000001C3 488B3C25[48000000]          mov     rdi, [.pcont]
   251 000001CB 488B3425[54000000]          mov     rsi, [.FILE]
   252 000001D3 E84CFFFFFF                  call OutCar     ; Получение периметра первой фигуры
   253                                  
   254 000001D8 59                          pop rcx
   255 000001D9 5B                          pop rbx
   256 000001DA FFC1                        inc ecx                 ; индекс следующей фигуры
   257                                  
   258 000001DC 488B0425[48000000]          mov     rax, [.pcont]
   259 000001E4 4883C018                    add     rax, 24         ; адрес следующей фигуры
   260 000001E8 48890425[48000000]          mov     [.pcont], rax
   261 000001F0 EBAF                        jmp .loop
   262                                  .return:
   263 000001F2 C9                      leave
   264 000001F3 C3                      ret
   265                                  
